<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nokia Legacy Converter</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="coi-serviceworker.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- FFmpeg (Stable) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <!-- NEW: JSZip for zipping folders -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Heebo', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        },
                        dark: {
                            800: '#1e1e2e',
                            900: '#11111b',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #11111b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        .glass {
            background: rgba(30, 30, 46, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .hidden-section { display: none; }
    </style>
</head>
<body class="bg-dark-900 text-gray-200 font-sans min-h-screen flex flex-col items-center justify-center p-4 selection:bg-brand-500 selection:text-white transition-all duration-300">

    <!-- Background -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-brand-500/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-500/10 rounded-full blur-[100px]"></div>
    </div>

    <!-- Language Toggle -->
    <div class="absolute top-6 right-6 z-50">
        <button id="langToggle" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-white bg-dark-800 border border-gray-700 hover:border-brand-500 transition-colors text-xs font-bold tracking-wider shadow-lg">
            <i data-lucide="globe" class="w-3 h-3"></i>
            <!-- This label will now show the TARGET language -->
            <span id="langLabel">HE</span>
        </button>
    </div>

    <!-- Main Card -->
    <div class="glass w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden relative">
        
        <!-- Header -->
        <div class="p-8 pb-4 text-center border-b border-white/5">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-brand-500/20 text-brand-500 mb-4">
                <i data-lucide="smartphone" class="w-6 h-6"></i>
            </div>
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400" data-i18n="title">
                Nokia Legacy Converter
            </h1>
            <p class="text-sm text-gray-400 mt-2" data-i18n="subtitle">
                Optimize videos for all MOCOR based devices
            </p>
        </div>

        <div class="p-8">
            
            <!-- STATE 1: UPLOAD -->
            <div id="section-upload" class="fade-enter-active">
                <div class="group relative w-full h-64 border-2 border-dashed border-gray-700 rounded-2xl hover:border-brand-500 hover:bg-brand-500/5 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center text-center" id="dropZone">
                    <!-- Added 'multiple' to allow file selection. Modern browsers allow folder drag & drop with this. -->
                    <input type="file" id="fileInput" accept="video/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    
                    <div class="p-4 transition-transform duration-300 group-hover:scale-110">
                        <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 group-hover:text-brand-500 group-hover:bg-brand-500/20 transition-colors">
                            <i data-lucide="folder-up" class="w-8 h-8"></i>
                        </div>
                        <p class="text-lg font-medium text-gray-200" data-i18n="dropText">
                            Drop folder or videos
                        </p>
                        <p class="text-sm text-gray-500 mt-1" data-i18n="browseText">
                            or click to browse
                        </p>
                    </div>
                </div>
                
                <div class="mt-6 flex items-start gap-3 p-4 bg-yellow-500/10 rounded-xl border border-yellow-500/20">
                    <i data-lucide="info" class="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5"></i>
                    <div class="text-xs text-yellow-200/80">
                        <strong class="block text-yellow-500 mb-1" data-i18n="specsTitle">Target Specs:</strong>
                        MJPEG Codec • 640x360 • 18 FPS • 1000k Bitrate • Mono Audio
                    </div>
                </div>
            </div>

            <!-- STATE 2: PROCESSING -->
            <div id="section-process" class="hidden-section fade-enter">
                <div class="flex flex-col items-center justify-center py-4">
                    <div class="relative w-20 h-20 mb-6">
                        <div class="absolute inset-0 border-4 border-gray-700 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-brand-500 rounded-full border-t-transparent animate-spin"></div>
                        <i data-lucide="cpu" class="absolute inset-0 m-auto w-8 h-8 text-gray-500 animate-pulse"></i>
                    </div>
                    
                    <h2 class="text-xl font-semibold animate-pulse" id="statusLabel" data-i18n="converting">Converting...</h2>
                    <p class="text-sm text-gray-500 mt-1 mb-6" id="subStatusLabel" data-i18n="waitText">Please wait...</p>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-800 rounded-full h-2.5 mb-2 overflow-hidden">
                        <div id="progressBar" class="bg-brand-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <!-- Console Log -->
                    <div id="log" class="w-full h-32 bg-black/50 rounded-xl border border-gray-800 p-3 font-mono text-[10px] text-green-400 overflow-y-auto custom-scroll mt-4 shadow-inner">
                        <div class="opacity-50">> System initialized...</div>
                    </div>
                </div>
            </div>

            <!-- STATE 3: SUCCESS -->
            <div id="section-success" class="hidden-section fade-enter text-center">
                <div class="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="check" class="w-10 h-10"></i>
                </div>
                
                <h2 class="text-2xl font-bold text-white mb-2" data-i18n="doneTitle">All Done!</h2>
                <p class="text-gray-400 text-sm mb-8" data-i18n="doneSubtitle">Your files are ready.</p>

                <a id="downloadBtn" class="flex items-center justify-center gap-2 w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-4 px-6 rounded-xl transition-all hover:scale-[1.02] shadow-lg shadow-brand-500/25 cursor-pointer">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span id="downloadText" data-i18n="downloadBtn">Download</span>
                </a>

                <button id="resetBtn" class="mt-4 text-sm text-gray-500 hover:text-white underline transition-colors" data-i18n="convertAnother">
                    Convert more files
                </button>
            </div>

        </div>
    </div>

    <a href="https://github.com/cfopuser/NokiaVidConvertor" target="_blank" class="mt-4 text-slate-400 hover:text-brand-dark transition">
        <i class="fa-brands fa-github text-xl"></i>
    </a>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;
    let currentLang = 'en';

    const translations = {
        en: {
            title: "Nokia Legacy Converter",
            subtitle: "Converts videos for all MOCOR based devices",
            dropText: "Drop folder or videos here",
            browseText: "or click to browse",
            specsTitle: "Target Specs:",
            loading: "Loading Engine...",
            converting: "Processing...",
            waitText: "Please wait, processing locally.",
            doneTitle: "All Done!",
            doneSubtitle: "Your videos are ready for your Nokia device.",
            downloadBtn: "Download Video",
            downloadZip: "Download All (ZIP)",
            convertAnother: "Convert another batch",
            error: "An error occurred.",
            status_read: "Reading file...",
            status_start: "Starting conversion...",
            status_complete: "Conversion complete!",
            batch_progress: "Processing file"
        },
        he: {
            title: "ממיר וידאו לנוקיה",
            subtitle: "עובד לכול המכשירים מבוססי MOCOR",
            dropText: "גרור תיקייה או סרטונים",
            browseText: "או לחץ לבחירה",
            specsTitle: "מפרט יעד:",
            loading: "טוען מנוע...",
            converting: "מעבד...",
            waitText: "אנא המתן, העיבוד מתבצע בדפדפן שלך.",
            doneTitle: "מוכן!",
            doneSubtitle: "הקבצים מוכנים למכשיר הנוקיה שלך.",
            downloadBtn: "הורד קובץ AVI",
            downloadZip: "הורד הכל (ZIP)",
            convertAnother: "המר קבצים נוספים",
            error: "אירעה שגיאה.",
            status_read: "קורא קובץ...",
            status_start: "מתחיל המרה...",
            status_complete: "ההמרה הושלמה!",
            batch_progress: "מעבד קובץ"
        }
    };

    function detectLanguage() {
        // Simple logic: if browser is HE, start in HE.
        // But if user manually set it, we might check localStorage (optional).
        const userLang = navigator.language || navigator.userLanguage;
        setLanguage(userLang.startsWith('he') ? 'he' : 'en');
    }

    function setLanguage(lang) {
        currentLang = lang;
        const isRTL = lang === 'he';
        const t = translations[lang];
        
        // Update DOM Direction
        document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
        
        // Update Language Button Label (Show the OPPOSITE language)
        // If current is EN, show HE. If current is HE, show EN.
        document.getElementById('langLabel').innerText = lang === 'en' ? 'HE' : 'EN';

        // Update Text Content
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(t[key]) {
                el.innerText = t[key];
            }
        });
    }

    // --- UI Helpers ---
    const logBox = document.getElementById('log');
    const progressBar = document.getElementById('progressBar');
    
    const log = (msg) => {
        const line = document.createElement('div');
        line.innerText = `> ${msg}`;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
    };

    function switchSection(sectionId) {
        ['section-upload', 'section-process', 'section-success'].forEach(id => {
            const el = document.getElementById(id);
            if (id === sectionId) {
                el.classList.remove('hidden-section');
                setTimeout(() => el.classList.add('fade-enter-active'), 10);
            } else {
                el.classList.remove('fade-enter-active');
                el.classList.add('hidden-section');
            }
        });
    }

    // --- Core Logic ---
    async function initFFmpeg() {
        if (!ffmpeg) {
            ffmpeg = createFFmpeg({
                log: false, 
                corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
            });
            await ffmpeg.load();
        }
    }

    // Handle multiple files
    async function processBatch(files) {
        switchSection('section-process');
        const t = translations[currentLang];
        logBox.innerHTML = '';
        
        document.getElementById('statusLabel').innerText = t.loading;
        
        try {
            await initFFmpeg();
            
            const zip = new JSZip(); // Initialize Zip
            const totalFiles = files.length;
            let processedCount = 0;
            let singleFileUrl = null;
            let singleFileName = "";

            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                
                // Update UI for batch progress
                document.getElementById('statusLabel').innerText = `${t.batch_progress} ${i + 1}/${totalFiles}`;
                document.getElementById('subStatusLabel').innerText = file.name;
                progressBar.style.width = '0%';
                
                log(`Processing: ${file.name}`);

                const safeName = 'input_video';
                const outputName = `converted_${i}.avi`;

                // 1. Write File
                ffmpeg.FS('writeFile', safeName, await fetchFile(file));

                // 2. Run FFmpeg
                // Setting up logger specifically for this run to animate progress bar roughly
                ffmpeg.setProgress(({ ratio }) => {
                    const percentage = Math.round(ratio * 100);
                    progressBar.style.width = `${percentage}%`;
                    // Optional: update the label with percentage
                    if (ratio > 0 && ratio < 1) {
                        document.getElementById('subStatusLabel').innerText = `${file.name} (${percentage}%)`;
                    }
                });

                await ffmpeg.run(
                    '-i', safeName,
                    '-c:v', 'mjpeg',
                    '-s', '640x360',
                    '-b:v', '1000k',
                    '-r', '18',
                    '-ac', '1',
                    '-ar', '32000',
                    outputName
                );

                progressBar.style.width = '100%';
                log(t.status_complete);

                // 3. Read File
                const data = ffmpeg.FS('readFile', outputName);
                
                // 4. Add to Zip or prepare single download
                const finalFileName = file.name.substring(0, file.name.lastIndexOf('.')) + '_nokia.avi';
                
                if (totalFiles === 1) {
                    singleFileUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/x-msvideo' }));
                    singleFileName = finalFileName;
                } else {
                    zip.file(finalFileName, data.buffer);
                }

                // 5. Cleanup
                ffmpeg.FS('unlink', safeName);
                ffmpeg.FS('unlink', outputName);
                processedCount++;
            }

            // --- Finish ---
            const btn = document.getElementById('downloadBtn');
            const btnText = document.getElementById('downloadText');

            if (totalFiles === 1) {
                // Single File Mode
                btn.href = singleFileUrl;
                btn.download = singleFileName;
                btnText.innerText = t.downloadBtn;
            } else {
                // Zip Mode
                document.getElementById('statusLabel').innerText = "Zipping files...";
                const content = await zip.generateAsync({ type: "blob" });
                const zipUrl = URL.createObjectURL(content);
                btn.href = zipUrl;
                btn.download = "nokia_converted_videos.zip";
                btnText.innerText = t.downloadZip;
            }

            switchSection('section-success');
            lucide.createIcons();

        } catch (err) {
            console.error(err);
            log(`ERROR: ${err.message}`);
            document.getElementById('statusLabel').innerText = t.error;
            document.getElementById('statusLabel').classList.add('text-red-500');
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('dropZone');
        const iconContainer = dropZone.querySelector('.group-hover\\:scale-110');
        const iconCircle = dropZone.querySelector('.group-hover\\:text-brand-500');

        const toggleHoverState = (isHovering) => {
            // Container styles
            dropZone.classList.toggle('border-brand-500', isHovering);
            dropZone.classList.toggle('bg-brand-500/5', isHovering);
            // Inner animation styles (matching your group-hover classes)
            if(iconContainer) iconContainer.classList.toggle('scale-110', isHovering);
            if(iconCircle) {
                iconCircle.classList.toggle('text-brand-500', isHovering);
                iconCircle.classList.toggle('bg-brand-500/20', isHovering);
            }
        };

        ['dragenter', 'dragover'].forEach(name => {
            dropZone.addEventListener(name, (e) => {
                e.preventDefault();
                toggleHoverState(true);
            });
        });

        ['dragleave', 'drop'].forEach(name => {
            dropZone.addEventListener(name, (e) => {
                e.preventDefault();
                toggleHoverState(false);
            });
        });

        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processBatch(Array.from(files));
            }
        });
        detectLanguage();
        lucide.createIcons();

        // Language Toggle
        document.getElementById('langToggle').onclick = () => {
            setLanguage(currentLang === 'en' ? 'he' : 'en');
        };

        // File Input
        const fileInput = document.getElementById('fileInput');
        fileInput.onchange = (e) => {
            if (e.target.files && e.target.files.length > 0) {
                // Convert FileList to Array to allow iteration
                processBatch(Array.from(e.target.files));
            }
        };

        // Reset
        document.getElementById('resetBtn').onclick = () => {
            fileInput.value = '';
            progressBar.style.width = '0%';
            switchSection('section-upload');
        };
    });
</script>
</body>
</html>